# Use case for pillarstack: higher level customers details

**NOTE:** For this example, templating in NOT done by `ext_pillar` pillarstack.

This use case is currently run by salt state + jinja template generating pillar file on the saltmaster.

Context: customers for a web agency are defined at higher level in `pillar/customers.sls`

## Source customers pillar

It looks like: (keys could be changed it's a prototype)

~~~yaml
wsf:
  customers:
    # keys for client names
    client1:
      domain-name: client1-domain.fr
      enabled: true
      # service to configure for this customer
      services:
        - webhost
        - dns
        - mysql
        - sftp
    # client2 as more default values
    client2:
      domain-name: more-domain.com
      enabled: true
      delete: false
      services:
        - webhost
        - dns
    client3:
      domain-name: somedomain.fr
      enabled: true
      # default, delete: false
      services:
        - webhost
        - dns
        - db
        - sftp
~~~

## Produced mysql-formula pillar

For this pillar we expect to generate users for having access to mariaDB.

Here's a *representation* of the merged output of `pillar/auto/mysql_db.sls` + `pillar/auto/mysql_users.sls`
Password management won't work that way, but it is just for description here. This pillar
is on the format expected by [mysql-formula](https://github.com/saltstack-formulas/mysql-formula).


~~~yaml
mysql:
  # Managed databases for customers
  # those databases are generated by the state/customers/init.sls
  database:
    - client1
    - client2
    - client3
  # merged…
  # Managed mariaDB users for customers
  # those mariaDB users are generated by the state/customers/init.sls
  # passwords are handled externally by a custom python script.
  user:
    client1:
      password: "{{ pass['client1']['mysql'] }}"
      hosts:
        - localhost
      databases:
        - database: client1
          grants: ['all privileges']
    client2:
      password: "{{ pass['client2']['mysql'] }}"
      hosts:
        - localhost
      databases:
        - database: client2
          grants: ['all privileges']
    client3:
      password: "{{ pass['client3']['mysql'] }}"
      hosts:
        - localhost
      databases:
        - database: client3
          grants: ['all privileges']
~~~

## install this state generator

`pillar/top.sls`:

~~~yaml
# vim: set ft=yaml:
#
# Pillar top inclusions
base:
  '*':
    # top level definition for customers avail to all rules
    - customers
  'db*':
    # pillar are merged
    # mysql.defaults it local site common usage of mysql-formula config…
    - mysql.defaults
    - auto.mysql_db
    - auto.mysql_users
~~~

## pillarstack
so…

It could probably be achieved dynamically with pillarstack.
